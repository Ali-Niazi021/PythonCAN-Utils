import React, { useState, useEffect, useCallback, useRef } from 'react';
import { Settings, Send, RefreshCw, Check, X, AlertTriangle } from 'lucide-react';
import './ModuleConfig.css';

// CAN ID calculation for BMS configuration
// Base ID: 0x08F0XF00 where X = module ID (bits 15:12)
const CONFIG_CMD_BASE = 0x08F00F00;
const CONFIG_ACK_BASE = 0x08F00F01;

// Command bytes
const CMD_SET_MODULE_ID = 0x01;
const CMD_SET_MAX_TEMP = 0x02;
const CMD_SET_MIN_TEMP = 0x03;
const CMD_SET_MIN_VOLTAGE = 0x04;
const CMD_SET_MAX_VOLTAGE = 0x05;
const CMD_GET_VALUE = 0x06;

// Parameter selectors for GET command
const PARAM_MODULE_ID = 0x01;
const PARAM_MAX_TEMP = 0x02;
const PARAM_MIN_TEMP = 0x03;
const PARAM_MIN_VOLTAGE = 0x04;
const PARAM_MAX_VOLTAGE = 0x05;

function ModuleConfig({ messages, onSendMessage, connected, onRegisterRawCallback }) {
  // Module configurations (keyed by module ID 0-15)
  const [moduleConfigs, setModuleConfigs] = useState({});
  // Input field values (separate from confirmed values)
  const [inputValues, setInputValues] = useState({});
  // Last ACK status per module
  const [ackStatus, setAckStatus] = useState({});
  // Which modules to show (detected or manually added)
  const [activeModules, setActiveModules] = useState([0]); // Start with module 0
  // New module ID input
  const [newModuleId, setNewModuleId] = useState('');
  // Loading state per module
  const [loadingModules, setLoadingModules] = useState({});
  // Global refresh in progress
  const [isRefreshingAll, setIsRefreshingAll] = useState(false);
  
  // Track processed message timestamps to avoid re-processing
  const processedTimestampsRef = useRef(new Set());
  // Store active modules in ref for callback access
  const activeModulesRef = useRef(activeModules);
  
  // Keep ref in sync with state
  useEffect(() => {
    activeModulesRef.current = activeModules;
  }, [activeModules]);

  // Calculate CAN ID for a module
  const getConfigCmdId = useCallback((moduleId) => CONFIG_CMD_BASE | (moduleId << 12), []);
  const getConfigAckId = useCallback((moduleId) => CONFIG_ACK_BASE | (moduleId << 12), []);

  // Process a single raw message (called for EVERY message, not aggregated)
  const processRawMessage = useCallback((msg) => {
    // Create unique key for this message
    const msgKey = `${msg.id}-${msg.timestamp}`;
    
    // Skip if already processed
    if (processedTimestampsRef.current.has(msgKey)) return;
    
    // Check each active module's ACK ID
    for (const moduleId of activeModulesRef.current) {
      const expectedAckId = CONFIG_ACK_BASE | (moduleId << 12);
      
      // Check if this message matches
      if (msg.id !== expectedAckId) continue;
      
      // Mark as processed
      processedTimestampsRef.current.add(msgKey);
      
      // Limit the set size to prevent memory growth
      if (processedTimestampsRef.current.size > 1000) {
        const arr = Array.from(processedTimestampsRef.current);
        processedTimestampsRef.current = new Set(arr.slice(-500));
      }
      
      // Extract data from decoded signals (server-side DBC decoding)
      const signals = msg.decoded?.signals;
      if (!signals) {
        console.log(`[ModuleConfig] Message matched but no decoded signals`);
        continue;
      }
      
      const cmdEcho = signals.Command_Echo;
      const status = signals.Status;
      const param = signals.Byte2_OldVal_or_Param;
      const valueLow = signals.Byte3_NewVal_or_ValLo;
      const valueHigh = signals.Byte4_ValHi || 0;
      
      console.log(`[ModuleConfig] ✓ MATCHED ACK for module ${moduleId}: cmd=${cmdEcho}, status=${status}, param=${param}, value=${valueLow}`);
      
      if (cmdEcho === 'GET_VALUE') {
        // GET response - update module config based on parameter
        setModuleConfigs(prev => {
          const updated = { ...prev };
          if (!updated[moduleId]) {
            updated[moduleId] = {};
          }
          
          // Map parameter names to config fields
          if (param === 'MODULE_ID' || param === PARAM_MODULE_ID) {
            updated[moduleId].moduleId = valueLow;
            console.log(`[ModuleConfig] Module ${moduleId}: moduleId = ${valueLow}`);
          } else if (param === 'MAX_TEMP' || param === PARAM_MAX_TEMP) {
            updated[moduleId].maxTemp = valueLow;
            console.log(`[ModuleConfig] Module ${moduleId}: maxTemp = ${valueLow}°C`);
          } else if (param === 'MIN_TEMP' || param === PARAM_MIN_TEMP) {
            // Handle signed byte
            const signedVal = valueLow > 127 ? valueLow - 256 : valueLow;
            updated[moduleId].minTemp = signedVal;
            console.log(`[ModuleConfig] Module ${moduleId}: minTemp = ${signedVal}°C`);
          } else if (param === 'MIN_VOLTAGE' || param === PARAM_MIN_VOLTAGE) {
            updated[moduleId].minVoltage = valueLow * 100; // Convert to mV
            console.log(`[ModuleConfig] Module ${moduleId}: minVoltage = ${valueLow * 100}mV`);
          } else if (param === 'MAX_VOLTAGE' || param === PARAM_MAX_VOLTAGE) {
            updated[moduleId].maxVoltage = valueLow * 100; // Convert to mV
            console.log(`[ModuleConfig] Module ${moduleId}: maxVoltage = ${valueLow * 100}mV`);
          }
          
          return updated;
        });
        
        // Update ACK status
        setAckStatus(prev => ({
          ...prev,
          [moduleId]: { type: 'get', success: status === 'SUCCESS', param: param, timestamp: Date.now() }
        }));
        
      } else {
        // SET response
        setAckStatus(prev => ({
          ...prev,
          [moduleId]: { 
            type: 'set', 
            cmd: cmdEcho, 
            success: status === 'SUCCESS' || status === 'NEEDS_RESET',
            needsReset: status === 'NEEDS_RESET',
            oldValue: param, 
            newValue: valueLow, 
            timestamp: Date.now() 
          }
        }));
        
        // If successful, refresh to get updated value
        if (status === 'SUCCESS' || status === 'NEEDS_RESET') {
          // The SET was successful, update the display
          setModuleConfigs(prev => {
            const updated = { ...prev };
            if (!updated[moduleId]) {
              updated[moduleId] = {};
            }
            
            // Map command echo to config field and update with new value
            if (cmdEcho === 'SET_MODULE_ID') {
              updated[moduleId].moduleId = valueLow;
            } else if (cmdEcho === 'SET_MAX_TEMP') {
              updated[moduleId].maxTemp = valueLow;
            } else if (cmdEcho === 'SET_MIN_TEMP') {
              updated[moduleId].minTemp = valueLow > 127 ? valueLow - 256 : valueLow;
            } else if (cmdEcho === 'SET_MIN_VOLTAGE') {
              updated[moduleId].minVoltage = valueLow * 100;
            } else if (cmdEcho === 'SET_MAX_VOLTAGE') {
              updated[moduleId].maxVoltage = valueLow * 100;
            }
            
            return updated;
          });
        }
      }
      
      break; // Found matching module, stop checking others
    }
  }, []);

  // Register for raw messages when component mounts
  useEffect(() => {
    if (onRegisterRawCallback) {
      console.log('[ModuleConfig] Registering for raw message callbacks');
      const unregister = onRegisterRawCallback(processRawMessage);
      return () => {
        console.log('[ModuleConfig] Unregistering raw message callbacks');
        unregister();
      };
    }
  }, [onRegisterRawCallback, processRawMessage]);

  // Send GET request for all parameters of a module with delays between each request
  const refreshModule = useCallback(async (moduleId) => {
    if (!connected || !onSendMessage) return;
    
    setLoadingModules(prev => ({ ...prev, [moduleId]: true }));
    
    const canId = getConfigCmdId(moduleId);
    const params = [PARAM_MODULE_ID, PARAM_MAX_TEMP, PARAM_MIN_TEMP, PARAM_MIN_VOLTAGE, PARAM_MAX_VOLTAGE];
    const paramNames = ['Module ID', 'Max Temp', 'Min Temp', 'Min Voltage', 'Max Voltage'];
    
    console.log(`[ModuleConfig] Refreshing module ${moduleId}, CAN ID: 0x${canId.toString(16).toUpperCase()}`);
    
    for (let i = 0; i < params.length; i++) {
      const param = params[i];
      console.log(`[ModuleConfig] Sending GET for ${paramNames[i]} (param ${param})`);
      await onSendMessage(canId, [CMD_GET_VALUE, param, 0, 0, 0, 0, 0, 0], true, false);
      // 500ms delay between requests to ensure we receive and process each response
      await new Promise(resolve => setTimeout(resolve, 500));
    }
    
    setLoadingModules(prev => ({ ...prev, [moduleId]: false }));
  }, [connected, onSendMessage, getConfigCmdId]);

  // Refresh all modules sequentially (not in parallel) to avoid message collisions
  const refreshAllModules = useCallback(async () => {
    if (!connected || !onSendMessage || isRefreshingAll) return;
    
    setIsRefreshingAll(true);
    console.log(`[ModuleConfig] Refreshing all ${activeModules.length} modules sequentially`);
    
    for (const moduleId of activeModules) {
      await refreshModule(moduleId);
      // Extra delay between modules
      await new Promise(resolve => setTimeout(resolve, 300));
    }
    
    setIsRefreshingAll(false);
  }, [connected, onSendMessage, activeModules, refreshModule, isRefreshingAll]);

  // Refresh all active modules on mount and when connection changes
  useEffect(() => {
    if (connected) {
      // Small delay to let connection stabilize
      const timer = setTimeout(() => {
        refreshAllModules();
      }, 500);
      return () => clearTimeout(timer);
    }
  }, [connected]); // eslint-disable-line react-hooks/exhaustive-deps

  // Send SET command
  const sendSetCommand = useCallback(async (moduleId, cmd, value) => {
    if (!connected || !onSendMessage) return;
    
    const canId = getConfigCmdId(moduleId);
    let byteValue = value;
    
    // Handle signed values for temperature
    if (cmd === CMD_SET_MIN_TEMP && value < 0) {
      byteValue = 256 + value; // Convert to unsigned byte representation
    }
    
    // Convert voltage to scaled value
    if (cmd === CMD_SET_MIN_VOLTAGE || cmd === CMD_SET_MAX_VOLTAGE) {
      byteValue = Math.round(value / 100); // Convert mV to scaled value
    }
    
    console.log(`[ModuleConfig] Sending SET cmd=0x${cmd.toString(16)}, value=${byteValue} to 0x${canId.toString(16).toUpperCase()}`);
    await onSendMessage(canId, [cmd, byteValue & 0xFF, 0, 0, 0, 0, 0, 0], true, false);
  }, [connected, onSendMessage, getConfigCmdId]);

  // Handle input change
  const handleInputChange = (moduleId, field, value) => {
    setInputValues(prev => ({
      ...prev,
      [moduleId]: {
        ...prev[moduleId],
        [field]: value
      }
    }));
  };

  // Add a new module to track
  const addModule = () => {
    const id = parseInt(newModuleId);
    if (!isNaN(id) && id >= 0 && id <= 15 && !activeModules.includes(id)) {
      setActiveModules(prev => [...prev, id].sort((a, b) => a - b));
      setNewModuleId('');
      // Refresh the new module
      setTimeout(() => refreshModule(id), 100);
    }
  };

  // Remove a module from tracking
  const removeModule = (moduleId) => {
    setActiveModules(prev => prev.filter(id => id !== moduleId));
    setModuleConfigs(prev => {
      const updated = { ...prev };
      delete updated[moduleId];
      return updated;
    });
    setInputValues(prev => {
      const updated = { ...prev };
      delete updated[moduleId];
      return updated;
    });
  };

  // Get display value (input if modified, otherwise current config)
  const getDisplayValue = (moduleId, field, defaultValue = '') => {
    if (inputValues[moduleId]?.[field] !== undefined) {
      return inputValues[moduleId][field];
    }
    if (moduleConfigs[moduleId]?.[field] !== undefined) {
      return moduleConfigs[moduleId][field];
    }
    return defaultValue;
  };

  // Check if value has been modified
  const isModified = (moduleId, field) => {
    const inputVal = inputValues[moduleId]?.[field];
    const configVal = moduleConfigs[moduleId]?.[field];
    return inputVal !== undefined && inputVal !== '' && String(inputVal) !== String(configVal);
  };

  // Clear ACK status after 5 seconds
  useEffect(() => {
    const timer = setInterval(() => {
      const now = Date.now();
      setAckStatus(prev => {
        const updated = { ...prev };
        let changed = false;
        Object.keys(updated).forEach(key => {
          if (now - updated[key].timestamp > 5000) {
            delete updated[key];
            changed = true;
          }
        });
        return changed ? updated : prev;
      });
    }, 1000);
    return () => clearInterval(timer);
  }, []);

  return (
    <div className="module-config">
      <div className="module-config-header">
        <Settings size={18} />
        <h2>BMS Module Configuration</h2>
        <button 
          onClick={refreshAllModules} 
          disabled={!connected || isRefreshingAll}
          className={`refresh-all-btn ${isRefreshingAll ? 'loading' : ''}`}
          title="Refresh all modules sequentially"
        >
          <RefreshCw size={14} className={isRefreshingAll ? 'spinning' : ''} />
          {isRefreshingAll ? 'Refreshing...' : 'Refresh All'}
        </button>
        <div className="module-add">
          <input
            type="number"
            min="0"
            max="15"
            placeholder="ID"
            value={newModuleId}
            onChange={(e) => setNewModuleId(e.target.value)}
            className="module-id-input"
          />
          <button onClick={addModule} disabled={!connected} className="add-module-btn">
            Add Module
          </button>
        </div>
      </div>

      {!connected && (
        <div className="config-warning">
          <AlertTriangle size={14} />
          <span>Connect to CAN bus to configure modules</span>
        </div>
      )}

      <div className="modules-container">
        {activeModules.map(moduleId => {
          const config = moduleConfigs[moduleId] || {};
          const ack = ackStatus[moduleId];
          const isLoading = loadingModules[moduleId];
          const canIdHex = `0x${getConfigCmdId(moduleId).toString(16).toUpperCase()}`;
          
          return (
            <div key={moduleId} className="module-card">
              <div className="module-card-header">
                <h3>Module {moduleId}</h3>
                <span className="can-id-badge">{canIdHex}</span>
                <div className="module-actions">
                  <button 
                    onClick={() => refreshModule(moduleId)} 
                    disabled={!connected || isLoading}
                    className={`refresh-btn ${isLoading ? 'loading' : ''}`}
                    title="Refresh all values (1s between each)"
                  >
                    <RefreshCw size={12} />
                  </button>
                  {activeModules.length > 1 && (
                    <button 
                      onClick={() => removeModule(moduleId)}
                      className="remove-btn"
                      title="Remove module"
                    >
                      <X size={12} />
                    </button>
                  )}
                </div>
              </div>

              {ack && (
                <div className={`ack-status ${ack.success ? 'success' : 'error'}`}>
                  {ack.success ? <Check size={12} /> : <X size={12} />}
                  {ack.type === 'set' ? (
                    <>
                      {ack.success ? 'Set OK' : 'Set failed'}
                      {ack.needsReset && ' (Reset required)'}
                      {ack.success && ` (${ack.oldValue} → ${ack.newValue})`}
                    </>
                  ) : (
                    ack.success ? 'Value received' : 'Read failed'
                  )}
                </div>
              )}

              <div className="config-grid">
                {/* Module ID */}
                <div className="config-row">
                  <label>Module ID</label>
                  <div className="config-value">
                    <span className={`current-value ${config.moduleId === undefined ? 'placeholder' : ''}`}>
                      {config.moduleId !== undefined ? config.moduleId : '—'}
                    </span>
                  </div>
                  <div className="config-input">
                    <input
                      type="number"
                      min="0"
                      max="15"
                      value={getDisplayValue(moduleId, 'newModuleId', '')}
                      onChange={(e) => handleInputChange(moduleId, 'newModuleId', e.target.value)}
                      placeholder="0-15"
                      disabled={!connected}
                    />
                    <button
                      onClick={() => sendSetCommand(moduleId, CMD_SET_MODULE_ID, parseInt(inputValues[moduleId]?.newModuleId))}
                      disabled={!connected || !isModified(moduleId, 'newModuleId')}
                      className="set-btn"
                      title="Set (requires reset)"
                    >
                      <Send size={10} />
                    </button>
                  </div>
                </div>

                {/* Max Temperature */}
                <div className="config-row">
                  <label>Max Temp</label>
                  <div className="config-value">
                    <span className={`current-value ${config.maxTemp === undefined ? 'placeholder' : ''}`}>
                      {config.maxTemp !== undefined ? `${config.maxTemp}°C` : '—'}
                    </span>
                  </div>
                  <div className="config-input">
                    <input
                      type="number"
                      min="0"
                      max="127"
                      value={getDisplayValue(moduleId, 'maxTemp', '')}
                      onChange={(e) => handleInputChange(moduleId, 'maxTemp', e.target.value)}
                      placeholder="°C"
                      disabled={!connected}
                    />
                    <button
                      onClick={() => sendSetCommand(moduleId, CMD_SET_MAX_TEMP, parseInt(inputValues[moduleId]?.maxTemp))}
                      disabled={!connected || !isModified(moduleId, 'maxTemp')}
                      className="set-btn"
                    >
                      <Send size={10} />
                    </button>
                  </div>
                </div>

                {/* Min Temperature */}
                <div className="config-row">
                  <label>Min Temp</label>
                  <div className="config-value">
                    <span className={`current-value ${config.minTemp === undefined ? 'placeholder' : ''}`}>
                      {config.minTemp !== undefined ? `${config.minTemp}°C` : '—'}
                    </span>
                  </div>
                  <div className="config-input">
                    <input
                      type="number"
                      min="-128"
                      max="127"
                      value={getDisplayValue(moduleId, 'minTemp', '')}
                      onChange={(e) => handleInputChange(moduleId, 'minTemp', e.target.value)}
                      placeholder="°C"
                      disabled={!connected}
                    />
                    <button
                      onClick={() => sendSetCommand(moduleId, CMD_SET_MIN_TEMP, parseInt(inputValues[moduleId]?.minTemp))}
                      disabled={!connected || !isModified(moduleId, 'minTemp')}
                      className="set-btn"
                    >
                      <Send size={10} />
                    </button>
                  </div>
                </div>

                {/* Min Voltage */}
                <div className="config-row">
                  <label>Min Voltage</label>
                  <div className="config-value">
                    <span className={`current-value ${config.minVoltage === undefined ? 'placeholder' : ''}`}>
                      {config.minVoltage !== undefined ? `${config.minVoltage}mV` : '—'}
                    </span>
                  </div>
                  <div className="config-input">
                    <input
                      type="number"
                      min="0"
                      max="25500"
                      step="100"
                      value={getDisplayValue(moduleId, 'minVoltage', '')}
                      onChange={(e) => handleInputChange(moduleId, 'minVoltage', e.target.value)}
                      placeholder="mV"
                      disabled={!connected}
                    />
                    <button
                      onClick={() => sendSetCommand(moduleId, CMD_SET_MIN_VOLTAGE, parseInt(inputValues[moduleId]?.minVoltage))}
                      disabled={!connected || !isModified(moduleId, 'minVoltage')}
                      className="set-btn"
                    >
                      <Send size={10} />
                    </button>
                  </div>
                </div>

                {/* Max Voltage */}
                <div className="config-row">
                  <label>Max Voltage</label>
                  <div className="config-value">
                    <span className={`current-value ${config.maxVoltage === undefined ? 'placeholder' : ''}`}>
                      {config.maxVoltage !== undefined ? `${config.maxVoltage}mV` : '—'}
                    </span>
                  </div>
                  <div className="config-input">
                    <input
                      type="number"
                      min="0"
                      max="25500"
                      step="100"
                      value={getDisplayValue(moduleId, 'maxVoltage', '')}
                      onChange={(e) => handleInputChange(moduleId, 'maxVoltage', e.target.value)}
                      placeholder="mV"
                      disabled={!connected}
                    />
                    <button
                      onClick={() => sendSetCommand(moduleId, CMD_SET_MAX_VOLTAGE, parseInt(inputValues[moduleId]?.maxVoltage))}
                      disabled={!connected || !isModified(moduleId, 'maxVoltage')}
                      className="set-btn"
                    >
                      <Send size={10} />
                    </button>
                  </div>
                </div>
              </div>

              <div className="config-note">
                <small>Temp/voltage thresholds reset to defaults on power cycle</small>
              </div>
            </div>
          );
        })}
      </div>
    </div>
  );
}

export default ModuleConfig;
